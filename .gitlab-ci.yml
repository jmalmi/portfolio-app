stages:
  - build_image
  - deploy_container
  - delete_image

build-image:
  stage: build_image
  tags:
    - portfolio-runner
  script:
    - IMAGENAME=portfolio
    - VERSIONED_IMAGENAME=$IMAGENAME:$(git rev-parse HEAD)
    - docker image build -t $VERSIONED_IMAGENAME .
    - docker image tag $VERSIONED_IMAGENAME $IMAGENAME:latest
    - docker image ls

deploy-containers:
  stage: deploy_container
  tags:
    - portfolio-runner
  script:
    - docker container stop portfolio-container
    - docker container rm portfolio-container
    - docker run -d -p 3000:3000 --name portfolio-container portfolio

delete-image:
  stage: delete_image
  tags:
    - portfolio-runner
  script:
    - IMAGENAME=portfolio
    # Delete image built five commits ago to leave five newest images
    - VERSIONED_IMAGENAME=$IMAGENAME:$(git rev-parse HEAD~5)
    - docker image rm $VERSIONED_IMAGENAME || echo "Failed to delete"

